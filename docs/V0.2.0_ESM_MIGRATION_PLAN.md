# v0.2.0 ESM Migration Plan

**Status**: Planning Phase  
**Target Release**: TBD (v0.1.5 completed November 4, 2025)  
**Type**: MAJOR VERSION (Breaking Change)  
**Priority**: HIGH (enables modern dependency updates)

## Overview

Migrate ascii-splash from CommonJS to ESM (ECMAScript Modules) to enable modern dependency updates, particularly conf v15+, and align with the JavaScript ecosystem's future direction.

## Motivation

### Primary Driver: Dependency Updates
- **conf v10.2.0 → v15.0.2** requires ESM (current blocker)
- conf v15+ is ESM-only (`"type": "module"`)
- Cannot update conf without full ESM migration

### Secondary Benefits
- ESM is the future of Node.js modules (officially recommended)
- Better tree-shaking and bundle optimization
- Improved static analysis capabilities
- Native browser compatibility (potential future feature)
- Aligns with modern tooling and ecosystem direction
- Enables future adoption of other modern ESM-only packages

## Breaking Changes

⚠️ **This is a major version bump: 0.1.x → 0.2.0**

### Impact Assessment

**For CLI Users (95% of users):**
- ✅ **NO CHANGES REQUIRED**
- `npm install -g ascii-splash` still works
- `npx ascii-splash` still works
- `splash` command still works
- Configuration files unchanged
- All patterns, themes, and commands work identically

**For Library Consumers (5% of users, if any):**
- ⚠️ Must update `require()` to `import` statements
- ⚠️ Must use ESM syntax in consuming code
- ⚠️ May need to update their own projects to ESM

**System Requirements:**
- Node.js 20+ (already required, no change)
- Modern terminal emulator (already required, no change)

## Migration Checklist

### Phase 1: Configuration Updates (1 hour)

#### package.json
- [ ] Change `"type": "commonjs"` → `"type": "module"`
- [ ] Update `"main": "dist/main.js"` → `"main": "./dist/main.js"` (explicit relative path)
- [ ] Add `"exports"` field for modern bundlers:
  ```json
  "exports": {
    ".": {
      "import": "./dist/main.js",
      "types": "./dist/main.d.ts"
    }
  }
  ```
- [ ] Update conf: `"conf": "^10.2.0"` → `"conf": "^15.0.2"`
- [ ] Add `"type": "module"` verification script

#### tsconfig.json
- [ ] Change `"module": "commonjs"` → `"module": "ES2020"`
- [ ] Change `"moduleResolution": "node"` → `"moduleResolution": "node16"`
- [ ] Verify `"esModuleInterop": true` is set
- [ ] Verify `"allowSyntheticDefaultImports": true` (if needed)

#### jest.config.js → jest.config.mjs
- [ ] Rename `jest.config.js` to `jest.config.mjs`
- [ ] Convert from `module.exports` to `export default`
- [ ] Add ESM configuration:
  ```javascript
  extensionsToTreatAsEsm: ['.ts'],
  globals: {
    'ts-jest': {
      useESM: true,
    },
  },
  moduleNameMapper: {
    '^(\\.{1,2}/.*)\\.js$': '$1',
  }
  ```

### Phase 2: Code Updates (2-3 hours)

#### Source Files (src/ directory, ~20 files)
- [ ] `src/main.ts` - Add `.js` extensions to all imports
- [ ] `src/types/index.ts` - No changes needed (type exports)
- [ ] `src/config/*.ts` (3 files) - Update imports
- [ ] `src/engine/*.ts` (5 files) - Update imports
- [ ] `src/patterns/*.ts` (17 files) - Update imports
- [ ] `src/renderer/*.ts` (2 files) - Update imports
- [ ] `src/utils/*.ts` (6 files) - Update imports
- [ ] Replace any `__dirname` usage with `import.meta.url` + `fileURLToPath`
- [ ] Replace any `require()` with `import`

**Import Pattern:**
```typescript
// Before (CommonJS)
import { Pattern } from './types/index';
import { WavePattern } from './patterns/WavePattern';

// After (ESM)
import { Pattern } from './types/index.js';
import { WavePattern } from './patterns/WavePattern.js';
```

#### Test Files (tests/ directory, ~35 files)
- [ ] `tests/unit/config/*.test.ts` (2 files)
- [ ] `tests/unit/engine/*.test.ts` (5 files)
- [ ] `tests/unit/patterns/*.test.ts` (17 files)
- [ ] `tests/unit/renderer/*.test.ts` (1 file)
- [ ] `tests/unit/utils/*.test.ts` (4 files)
- [ ] `tests/utils/*.ts` (2 files) - Mock and helper files
- [ ] Update all imports to include `.js` extensions

#### Manual Test Scripts (tests/manual/ directory, 8 files)
- [ ] `tests/manual/*.mjs` - Already ESM, verify compatibility
- [ ] May need minor updates if they import from src/

### Phase 3: Build System (1 hour)

- [ ] Run TypeScript compiler: `npm run build`
- [ ] Verify output in `dist/` directory
- [ ] Check generated `.js` files use ESM syntax (`export`, `import`)
- [ ] Verify CLI shebang works: `#!/usr/bin/env node`
- [ ] Test CLI binary directly: `node dist/main.js`
- [ ] Verify package.json scripts:
  - [ ] `npm run build` (TypeScript compilation)
  - [ ] `npm run dev` (watch mode)
  - [ ] `npm start` (run application)
  - [ ] `npm run lint` (type checking)

### Phase 4: Testing (2-3 hours)

#### Unit Tests
- [ ] Configure Jest for ESM (`jest.config.mjs`)
- [ ] Run full test suite: `npm test`
- [ ] **Target**: All 1505 tests passing ✅
- [ ] **Target**: Coverage ≥82.34% maintained ✅
- [ ] Fix any test failures incrementally
- [ ] Common issues to watch:
  - Mock imports (may need adjustments)
  - Dynamic imports (syntax changes)
  - Path resolution (`.js` extensions)

#### Manual Testing
- [ ] Global install test: `npm install -g .` → `splash`
- [ ] npx test: `npx .` (local package)
- [ ] Pattern switching: Test all 17 patterns (keys 1-9, n)
- [ ] Preset cycling: Test `.` and `,` keys
- [ ] Theme cycling: Test `t` key
- [ ] Command system: Test `c01`, `cp3`, `ct2`, etc.
- [ ] Configuration loading: Test `~/.config/ascii-splash/.splashrc.json`
- [ ] Mouse interactions: Test click and move events
- [ ] Performance: Monitor CPU <5%, RAM <50MB
- [ ] Terminal resize: Test responsive rendering

#### Integration Testing
- [ ] Test on macOS (primary development platform)
- [ ] Test on Linux (CI/CD environment)
- [ ] Test in different terminals (iTerm2, Terminal.app, VSCode)
- [ ] Test with different Node versions (20.x, 22.x)

### Phase 5: GitHub Actions Workflow Optimization (1 hour)

#### Remove Redundant Test Execution
**Current Issue:** Tests run twice in release workflow
- Line 32-33: `npm test` (runs 1505 tests)
- Line 35-36: `npm run test:coverage` (runs 1505 tests AGAIN)

**Solution Option 1: Single Coverage Run (Recommended)**
```yaml
jobs:
  test:
    name: Run Tests
    timeout-minutes: 10
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    - name: Install dependencies
      run: npm ci
    - name: Run TypeScript compiler
      run: npm run build
    - name: Run tests with coverage
      run: npm run test:coverage
      timeout-minutes: 5
```

**Solution Option 2: Parallel Jobs**
```yaml
jobs:
  test:
    strategy:
      matrix:
        task: [build, test, coverage]
    steps:
    - name: Run ${{ matrix.task }}
      run: npm run ${{ matrix.task }}
```

#### Add Timeouts
- [ ] Job-level timeout: `timeout-minutes: 10`
- [ ] Step-level timeout for tests: `timeout-minutes: 5`
- [ ] Prevents 6-hour default timeout on hangs

#### Test Workflow
- [ ] Create feature branch: `feature/esm-migration`
- [ ] Push test tag: `v0.2.0-beta.1`
- [ ] Verify workflow completes in <6 minutes
- [ ] Verify npm publish works (dry-run first)

### Phase 6: Documentation (1 hour)

#### CHANGELOG.md
- [ ] Add `## [0.2.0] - YYYY-MM-DD` section
- [ ] Document breaking changes:
  ```markdown
  ### BREAKING CHANGES
  - **ESM Migration**: Project now uses ECMAScript Modules (ESM)
    - CLI users: No changes required
    - Library consumers: Must update to ESM syntax
    - Node.js 20+ required (already a requirement)
  
  ### Changed
  - Migrated from CommonJS to ESM
  - Updated conf to v15.0.2 (ESM-compatible)
  - Optimized GitHub Actions workflow (reduced test duplication)
  
  ### Technical
  - All imports now use `.js` extensions
  - `package.json` now has `"type": "module"`
  - TypeScript outputs ESM syntax
  - Jest configured for ESM testing
  ```

#### README.md
- [ ] Verify installation instructions still accurate
- [ ] Add note about Node.js 20+ requirement (already there)
- [ ] Update any code examples (if applicable)
- [ ] Verify all commands still work

#### ARCHITECTURE.md
- [ ] Update "Module System" section
- [ ] Document ESM import conventions
- [ ] Update any code examples
- [ ] Note TypeScript configuration changes

#### CLAUDE.md
- [ ] Update "Tech Stack" section (CommonJS → ESM)
- [ ] Update import examples
- [ ] Note new import conventions (`.js` extensions)

#### Migration Guide (New)
- [ ] Create `docs/ESM_MIGRATION_GUIDE.md` for library consumers
- [ ] Document CommonJS → ESM changes
- [ ] Provide code examples
- [ ] Link from CHANGELOG

## Technical Implementation Details

### Import Statement Changes

**Before (CommonJS):**
```typescript
// src/engine/AnimationEngine.ts
import { Pattern } from '../types/index';
import { TerminalRenderer } from '../renderer/TerminalRenderer';
import { PerformanceMonitor } from './PerformanceMonitor';
```

**After (ESM):**
```typescript
// src/engine/AnimationEngine.ts
import { Pattern } from '../types/index.js';  // ← Add .js
import { TerminalRenderer } from '../renderer/TerminalRenderer.js';  // ← Add .js
import { PerformanceMonitor } from './PerformanceMonitor.js';  // ← Add .js
```

### __dirname Replacement

**Before (CommonJS):**
```typescript
import * as path from 'path';
const configPath = path.join(__dirname, '..', 'config', 'defaults.json');
```

**After (ESM):**
```typescript
import * as path from 'path';
import { fileURLToPath } from 'url';
import { dirname } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const configPath = path.join(__dirname, '..', 'config', 'defaults.json');
```

### Jest Configuration

**Before (jest.config.js):**
```javascript
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  roots: ['<rootDir>/src', '<rootDir>/tests'],
  testMatch: ['**/?(*.)+(spec|test).ts'],
  // ...
};
```

**After (jest.config.mjs):**
```javascript
export default {
  preset: 'ts-jest',
  testEnvironment: 'node',
  extensionsToTreatAsEsm: ['.ts'],
  globals: {
    'ts-jest': {
      useESM: true,
    },
  },
  moduleNameMapper: {
    '^(\\.{1,2}/.*)\\.js$': '$1',  // Map .js imports to .ts files
  },
  roots: ['<rootDir>/src', '<rootDir>/tests'],
  testMatch: ['**/?(*.)+(spec|test).ts'],
  // ...
};
```

### package.json Configuration

**Before:**
```json
{
  "name": "ascii-splash",
  "version": "0.1.5",
  "type": "commonjs",
  "main": "dist/main.js",
  "bin": {
    "splash": "./dist/main.js"
  },
  "engines": {
    "node": ">=20.0.0"
  }
}
```

**After:**
```json
{
  "name": "ascii-splash",
  "version": "0.2.0",
  "type": "module",
  "main": "./dist/main.js",
  "exports": {
    ".": {
      "import": "./dist/main.js",
      "types": "./dist/main.d.ts"
    }
  },
  "bin": {
    "splash": "./dist/main.js"
  },
  "engines": {
    "node": ">=20.0.0"
  }
}
```

### tsconfig.json Configuration

**Before:**
```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "moduleResolution": "node",
    "esModuleInterop": true,
    // ...
  }
}
```

**After:**
```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "ES2020",
    "moduleResolution": "node16",
    "esModuleInterop": true,
    "allowSyntheticDefaultImports": true,
    // ...
  }
}
```

## Risks & Mitigation Strategies

### Risk 1: Test Failures After Migration
**Likelihood**: Medium  
**Impact**: High  
**Mitigation**:
- Run tests after each phase
- Fix failures incrementally
- Use feature branch for testing
- Keep v0.1.5 as stable fallback

### Risk 2: CLI Binary Breakage
**Likelihood**: Low  
**Impact**: Critical  
**Mitigation**:
- Test `npx ascii-splash` after each phase
- Verify shebang works: `#!/usr/bin/env node`
- Test global install manually
- Test on clean system (CI/CD)

### Risk 3: terminal-kit ESM Compatibility
**Likelihood**: Low (terminal-kit is CommonJS but should interop)  
**Impact**: High  
**Mitigation**:
- Verify terminal-kit works with ESM early
- Check for known issues in terminal-kit repo
- Have fallback plan (stay on v0.1.5)

### Risk 4: Jest ESM Configuration Issues
**Likelihood**: Medium  
**Impact**: Medium  
**Mitigation**:
- Follow ts-jest ESM documentation closely
- Test configuration incrementally
- Use jest.config.mjs best practices
- Reference successful ESM+Jest projects

### Risk 5: GitHub Actions Workflow Issues
**Likelihood**: Low  
**Impact**: Medium  
**Mitigation**:
- Test workflow on feature branch first
- Use beta tags (v0.2.0-beta.1)
- Dry-run npm publish
- Monitor workflow logs carefully

### Risk 6: Breaking Changes for Library Consumers
**Likelihood**: Low (minimal library usage expected)  
**Impact**: Medium  
**Mitigation**:
- Document changes in CHANGELOG
- Create migration guide
- Use major version bump (0.2.0)
- Provide code examples

## Rollback Plan

If critical issues are discovered after release:

### Immediate Actions
1. **Revert npm**: `npm unpublish ascii-splash@0.2.0` (within 72 hours)
2. **Re-publish v0.1.5**: `npm publish` from v0.1.5 tag
3. **GitHub Release**: Mark v0.2.0 as "Pre-release" or delete
4. **Announce**: Post issue on GitHub explaining rollback

### Recovery Plan
1. Create hotfix branch from `v0.1.5` tag
2. Document issues discovered in v0.2.0
3. Create new planning document: `V0.3.0_ESM_MIGRATION_PLAN_V2.md`
4. Address issues before retry
5. Consider longer beta testing period

### Criteria for Rollback
- CLI binary doesn't work
- >10% of tests failing
- Critical runtime errors
- npm package unusable
- Performance regression >20%

## Timeline Estimate

**Total Estimated Time: 8-12 hours of focused work**

| Phase | Task | Estimated Time | Complexity |
|-------|------|----------------|------------|
| 1 | Configuration Updates | 1 hour | Low |
| 2 | Code Updates (src/) | 2 hours | Medium |
| 2 | Code Updates (tests/) | 1 hour | Medium |
| 3 | Build System | 1 hour | Low |
| 4 | Unit Testing | 2 hours | Medium |
| 4 | Manual Testing | 1 hour | Low |
| 5 | Workflow Optimization | 1 hour | Low |
| 6 | Documentation | 1 hour | Low |
| - | **Buffer/Debugging** | 2-4 hours | Variable |

**Recommended Approach:**
- Day 1 (4 hours): Phases 1-3 (config, code, build)
- Day 2 (4 hours): Phase 4 (testing and fixes)
- Day 3 (2-4 hours): Phases 5-6 (workflow, docs) + final testing

## Success Criteria

### Build & Tests
- ✅ TypeScript compiles without errors
- ✅ All 1505 tests passing
- ✅ Test coverage ≥82.34% (maintained)
- ✅ No new linting errors
- ✅ Build time similar to v0.1.5 (~10 seconds)

### Functionality
- ✅ CLI works: `splash` command launches application
- ✅ npx works: `npx ascii-splash` launches application
- ✅ Global install works: `npm install -g ascii-splash`
- ✅ All 17 patterns render correctly
- ✅ All 102 presets work
- ✅ All 5 themes work
- ✅ Command system works (40+ commands)
- ✅ Mouse interactions work (click, move)
- ✅ Configuration loading works

### Performance
- ✅ CPU usage <5% idle (maintained)
- ✅ Memory usage ~40-50MB (maintained)
- ✅ FPS stable at 30 (MEDIUM preset)
- ✅ No performance regression

### Dependencies
- ✅ conf updated to v15.0.2
- ✅ All dependencies compatible with ESM
- ✅ No security vulnerabilities (`npm audit`)
- ✅ Package size similar to v0.1.5

### CI/CD
- ✅ GitHub Actions workflow completes successfully
- ✅ Workflow time <6 minutes (improved from ~6 minutes)
- ✅ npm publish succeeds
- ✅ GitHub Release created with changelog

### Documentation
- ✅ CHANGELOG.md updated with breaking changes
- ✅ README.md accurate and up-to-date
- ✅ ARCHITECTURE.md reflects ESM changes
- ✅ Migration guide created (if needed)
- ✅ All code examples work

## Pre-Migration Checklist

**Before starting migration, ensure:**
- [ ] v0.1.5 is stable on npm ✅ (completed November 4, 2025)
- [ ] No critical issues reported on GitHub
- [ ] All current PRs merged or closed
- [ ] `main` branch is clean and up-to-date
- [ ] Local environment is clean (`node_modules` fresh)
- [ ] Backup/tag created: `git tag v0.1.5-backup`

## Post-Migration Verification

**After migration, verify:**
- [ ] Run application locally: `npm start`
- [ ] Test all 17 patterns manually
- [ ] Test command system thoroughly
- [ ] Check configuration loading
- [ ] Monitor performance (CPU, RAM)
- [ ] Test on fresh install (clean `node_modules`)
- [ ] Test global install on clean system
- [ ] Review GitHub Actions logs
- [ ] Check npm package contents
- [ ] Monitor for GitHub issues (24-48 hours)

## References & Resources

### Official Documentation
- [Node.js ESM Documentation](https://nodejs.org/api/esm.html)
- [TypeScript ESM Support](https://www.typescriptlang.org/docs/handbook/esm-node.html)
- [Jest ESM Support](https://jestjs.io/docs/ecmascript-modules)
- [ts-jest ESM Configuration](https://kulshekhar.github.io/ts-jest/docs/guides/esm-support/)

### Package Documentation
- [conf v15 Release Notes](https://github.com/sindresorhus/conf/releases/tag/v15.0.0)
- [conf v15 Migration Guide](https://github.com/sindresorhus/conf#migration)
- [commander.js ESM Support](https://github.com/tj/commander.js#esm)
- [terminal-kit Documentation](https://github.com/cronvel/terminal-kit)

### Community Resources
- [Pure ESM Package Guide](https://gist.github.com/sindresorhus/a39789f98801d908bbc7ff3ecc99d99c)
- [Node.js ESM Best Practices](https://nodejs.org/docs/latest/api/esm.html#esm_differences_between_es_modules_and_commonjs)
- [TypeScript ESM Tips](https://www.typescriptlang.org/docs/handbook/modules.html#es-module-syntax)

### Example Projects (ESM + TypeScript + Jest)
- Look for open-source projects using similar stack
- Reference their jest.config.mjs
- Study their tsconfig.json ESM configuration

## Notes for Future Sessions

### Quick Start Commands
```bash
# Create feature branch
git checkout -b feature/esm-migration

# Verify current state
npm test
npm run build
npm start

# After migration
npm run build
npm test
npm start

# Test CLI
npm install -g .
splash

# Clean install test
rm -rf node_modules package-lock.json
npm install
npm test
```

### Key Files to Modify (in order)
1. `package.json` - Add `"type": "module"`
2. `tsconfig.json` - Change module settings
3. `jest.config.js` → `jest.config.mjs` - ESM config
4. `src/**/*.ts` - Add `.js` to imports (use find/replace)
5. `tests/**/*.ts` - Add `.js` to imports (use find/replace)
6. `.github/workflows/release.yml` - Optimize tests

### Find/Replace Patterns
```bash
# Find all imports without .js extension (regex)
import .* from ['"](\./.*|\.\./.*)['"];

# Replace pattern (manual verification needed)
# Add .js before the closing quote
```

### Testing Strategy
1. Update config files first
2. Run build - expect TypeScript errors
3. Fix imports incrementally (one directory at a time)
4. Run tests after each directory
5. Fix test failures as you go
6. Manual testing last

---

**Document Created**: November 4, 2025  
**Last Updated**: November 4, 2025  
**Status**: Ready for Implementation  
**Prerequisites**: v0.1.5 published successfully ✅  
**Next Action**: Create feature branch `feature/esm-migration`  

**Session Resume**: Use this document as the complete plan for v0.2.0 ESM migration. All technical details, risks, and steps are documented. Estimated 8-12 hours of focused work across 3 days.
